<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Easy Batch &bull; Indexing ElasticSearch tutorial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Mahmoud Ben Hassine">
    <meta name="description" content="open source lightweight batch processing framework for Java">
    <meta name="keyword" content="java, batch, batch processing, open source">

    <!-- Bootstrap CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="../css/font-awesome.min.css" rel="stylesheet">

    <!-- Plugins -->
    <link href="../css/highlight/default.css" media="screen" rel="stylesheet" />
    <link href="../css/clingify/clingify.css" rel="stylesheet">

    <!-- Theme style -->
    <link href="../css/theme-style.min.css" rel="stylesheet">

    <!--Your custom colour override-->
    <link href="../css/colour-blue.css" id="colour-scheme" rel="stylesheet">

    <!-- Your custom override -->
    <link href="../css/custom-style.css" rel="stylesheet">

    <!-- HTML5 shiv & respond.js for IE6-8 support of HTML5 elements & media queries -->
    <!--[if lt IE 9]>
    <script src="../js/plugins/html5shiv/html5shiv.js"></script>
    <script src="../js/plugins/respond/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="../img/misc/gear.ico">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,300|Rambla|Calligraffitti' rel='stylesheet' type='text/css'>

    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-35599235-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>

</head>
<body class="page page-index-static">

<a href="#content" class="sr-only">Skip to content</a>
<div id="navigation" class="wrapper">
    <div class="navbar-static-top">

        <!--Header & Branding region-->
        <div class="header">
            <div class="header-inner container">
                <div class="row">
                    <div class="col-md-8">
                        <!--branding/logo-->
                        <a class="navbar-brand" href="../index.html" title="Home">
                            <h1><span>Easy</span>Batch</h1>
                        </a>
                        <div class="slogan">Batch processing with Java made easy</div>
                    </div>
                    <div class="col-md-4">
                        <!--social media icons-->
                        <div class="social-media">
                            <a href="https://github.com/EasyBatch/easybatch-framework" title="View on GitHub" target="_blank"><i class="fa fa-github"></i></a>
                            <a href="https://twitter.com/intent/tweet?url=http://www.easybatch.org/&text=Easy%20Batch:%20batch%20processing%20with%20Java%20made%20easy&via=md_benhassine" title="Share on Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
                            <a href="https://plus.google.com/share?url=http://www.easybatch.org&text=Easy%20Batch:%20batch%20processing%20with%20Java%20made%20easy" title="Share on Google+" target="_blank"><i class="fa fa-google-plus"></i></a>
                            <a href="https://gitter.im/EasyBatch/easybatch-framework" title="Chat on Gitter" target="_blank"><i class="fa fa-comment"></i></a>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="container" data-toggle="clingify">
            <div class="navbar">
                <!--
              mobile collapse menu button
              - data-toggle="toggle" = default BS menu
              - data-toggle="jpanel-menu" = jPanel Menu
              -->
                <a class="navbar-btn" data-toggle="jpanel-menu" data-target=".navbar-collapse"> <span class="bar"></span> <span class="bar"></span> <span class="bar"></span> <span class="bar"></span> </a>

                <!--user menu-->
                <div class="user-menu pull-right"> <a href="https://oss.sonatype.org/content/groups/public/org/easybatch/" title="Download Easy Batch from Maven central repository" class="btn btn-primary" target="_blank"><i class="fa fa-download"></i> version : 3.0.0</a> </div>

                <!--everything within this div is collapsed on mobile-->
                <div class="navbar-collapse collapse">

                    <!--main navigation-->
                    <ul class="nav navbar-nav">
                        <li><a href="../index.html"><i class="fa fa-home fa-lg"></i> Home</a></li>
                        <li class="dropdown"> <a href="#" class="dropdown-toggle menu-item" id="features-drop" data-toggle="dropdown"><i class="fa fa-book fa-lg" ></i> Documentation +</a>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="about-drop">
                                <li role="presentation"><a role="menuitem" href="../documentation/getting-started.html" class="menu-item"><i class="fa fa-play fa-lg"></i> Getting started</a></li>
                                <li role="presentation"><a role="menuitem" href="../documentation/architecture.html" tabindex="-1" class="menu-item"><i class="fa fa-flask fa-lg"></i> Architecture</a></li>
                                <li role="presentation"><a role="menuitem" href="../documentation/user-guide.html" tabindex="-1" class="menu-item"><i class="fa fa-book fa-lg"></i> User guide</a></li>
                                <li role="presentation"><a role="menuitem" href="../api/index.html" tabindex="-1" class="menu-item" target="_blank"><i class="fa fa-folder-open fa-lg"></i> API docs</a></li>
                                <li role="presentation"><a role="menuitem" href="../documentation/faq.html" tabindex="-1" class="menu-item"><i class="fa fa-question-circle fa-lg"></i> FAQs</a></li>
                                <li role="presentation"><a role="menuitem" href="https://speakerdeck.com/benas/easy-batch" target="_blank" tabindex="-1" class="menu-item"><i class="fa fa-video-camera fa-lg"></i> Presentation slides</a></li>
                            </ul>
                        </li>
                        <li><a href="../tutorials/index.html" class="menu-item"><i class="fa fa-code fa-lg"></i> Tutorials</a></li>
                        <li class="dropdown"> <a href="" class="dropdown-toggle" id="about-drop" data-toggle="dropdown"><i class="fa fa-thumbs-o-up fa-lg"></i> Get involved +</a>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="about-drop">
                                <li role="presentation"><a role="menuitem" href="https://github.com/EasyBatch/easybatch-framework" target="_blank" tabindex="-1" class="menu-item"><i class="fa fa-github fa-lg"></i> Source repository</a></li>
                                <li role="presentation"><a role="menuitem" href="https://github.com/EasyBatch/easybatch-framework/issues" target="_blank" tabindex="-1" class="menu-item"><i class="fa fa-bug fa-lg"></i> Issue tracker</a></li>
                            </ul>
                        </li>

                    </ul>
                </div>
                <!--/.navbar-collapse -->
            </div>
        </div>
    </div>
</div>

<div id="content">
    <div class="container">

        <!-- breadcrumb -->
<ul class="breadcrumb">
    <li><a href="../index.html">Home</a></li>
    
    <li><a href="../tutorials/index.html">Tutorials</a></li>
    
    
    <li class="active">Indexing ElasticSearch tutorial</li>
</ul>

        <div class="row">
            <div class="col-md-9">

                <h1 class="title-divider"><span>Indexing ElasticSearch tutorial</span></h1>

                      <h2>1. Introduction</h2>

        <p>In the <a href="./loading-data.html">previous tutorial</a>, you saved tweets to a relational database.
        Unfortunately, it turns out that search feature provided by the relational database system is not
            sufficient as your tweets database grows. You decided to make tweets searchable using <a href="http://www.elasticsearch.org/" target="_blank">ElasticSearch</a>.
        Nice decision <i class="fa fa-smile-o"></i></p>

        <p>In this tutorial, you will see how you can use Easy Batch to extract tweets from the database, transform them to Json format and then load them in ElasticSearch.
        This is a typical <a href="http://fr.wikipedia.org/wiki/Extract_Transform_Load">Extract-Transform-Load</a> scenario.</p>

        <p>Let's get started!</p>

<h2>2. What youâ€™ll need</h2>

<ul>
    <li>JDK 1.6+</li>
    <li>Maven</li>
    <li>Git (Optional)</li>
    <li>Your favorite IDE (Optional)</li>
</ul>

<h2>3. Extracting tweets from the database</h2>

        Easy Batch provides the <code><em>JdbcRecordReader</em></code> that is designed to read data from a relational database using the
<a href="http://docs.oracle.com/javase/tutorial/jdbc/" target="_blank">JDBC</a> API.

        <p>You will use this reader to read tweets from the database:</p>

    <div class="bs-callout bs-callout-code">
<pre><code class="java">Engine engine = new EngineBuilder()
    <strong>.reader(new JdbcRecordReader(connection, "select * from tweet"))</strong>
    .build();
</code></pre>
    </div>

        <p>The <code><em>JdbcRecordReader</em></code> must be configured with a JDBC connection and the query to be used to fetch data.</p>
        <p>This reader produces <code><em>JdbcRecord</em></code> instances having a <code><em>java.sql.ResultSet</em></code> payload.
        You can access data of the current record using this payload.</p>

<h2>4. Transforming tweets to Json objects</h2>

        <p>Before transforming tweets to Json, you would like to map relational data to instances of the <code><em>Tweet</em></code> bean. This is the Pojo-centric approach Easy Batch is all about.
            Once you get tweet objects, it will be easy to use ElasticSearch's APIs to index data in Json format.</p>

        <p>The <code><em>JdbcRecordMapper</em></code> provided by Easy Batch allows to you to map relational records to domain objects:</p>

<div class="bs-callout bs-callout-code">
<pre><code class="java">Engine engine = new EngineBuilder()
    .reader(new JdbcRecordReader(connection, "select * from tweet"))
    <strong>.mapper(new JdbcRecordMapper(Tweet.class)</strong>
    .build();
</code></pre>
</div>

        <p>You must specify the type of the target domain object to which the mapper should map data. This mapper will use
        the table's meta-data to determine column names and map values to corresponding fields of the domain object.</p>

        <p>This mapper will produce <code><em>Tweet</em></code> objects that you can use to index ElasticSearch.</p>

<h2>5. Loading tweets in ElasticSearch</h2>

        <p>At this stage, you will write a record processor that consumes <code><em>Tweet</em></code> objects and uses APIs provided
        by ElasticSearch to index data in Json format. Here is the <code><em>TweetTransformer</em></code>:</p>

        <div class="bs-callout bs-callout-code">
            <h5>TweetTransformer.java</h5>
<pre><code class="java">public class TweetTransformer implements RecordProcessor&lt;Tweet, String&gt; {

    @Override
    public String processRecord(Tweet tweet) throws Exception {

        XContentBuilder builder = jsonBuilder()
            .startObject()
            .field("id", tweet.getId())
            .field("user", tweet.getUser())
            .field("message", tweet.getMessage())
            .endObject();

        return builder.string();
    }

}</code></pre>
        </div>

        <p>No magic, the processor transform tweet object into strings in Json format ready to be indexed in ElasticSearch.</p>

        <p>Now, it is time to write the code to index tweets in Json format into ElasticSearch.
            To keep the tutorial simple, we will use an embedded ElasticSearch server holding a <code>twitter</code> index.
            Here is the code of the <code><em>TweetIndexer</em></code>:</p>

<div class="bs-callout bs-callout-code">
    <h5>TweetIndexer.java</h5>
<pre><code class="java">public class TweetIndexer implements RecordProcessor&lt;String, String&gt; {

    /** Elastic search client */
    private Client client;

    public TweetIndexer(Client client) {
        this.client = client;
    }

    @Override
    public String processRecord(String tweet) throws Exception {

        //index the tweet in the twitter index
        client.prepareIndex("twitter", "tweet")
            .setSource(tweet)
            .execute()
            .actionGet();

        return tweet;
    }

}</code></pre>
</div>

<div class="bs-callout bs-callout-warning">
    <h5><i class="fa fa-info-circle"></i> Heads up!</h5>
    <p>We could have merged the <code>TweetTransformer</code> and <code>TweetIndexer</code> together, but it is not encouraged to do so for many reasons:</p>
    <ul>
        <li>The merged processor will have two responsibilities at the same time, mapping and indexing, which violates the Single Responsibility Principle</li>
        <li>The mapping logic will be impossible to reuse in another application</li>
        <li>Both features could not be unit-tested</li>
    </ul>
</div>

<h2>6. Putting it all together</h2>

        <p>To run the tutorial, you will use this class:</p>

<div class="bs-callout bs-callout-code">
<pre><code class="java">public class ElasticSearchTutorial {

    public static void main(String[] args) throws Exception {

        /*
        * Start embedded database server
        */
        Connection connection = DatabaseUtil.startEmbeddedDatabase();
        DatabaseUtil.populateTweetTable(connection);

        //start embedded elastic search node
        Node node = ElasticSearchUtils.startEmbeddedNode();
        Client client = node.client();

        <strong>// Build a batch engine
        Engine engine = new EngineBuilder()
            .reader(new JdbcRecordReader(connection, "select * from tweet"))
            .mapper(new JdbcRecordMapper(Tweet.class))
            .processor(new TweetTransformer())
            .processor(new TweetIndexer(client))
            .build();

        // Run the batch engine
        engine.call();
        </strong>
        //check if tweets have been successfully indexed in elastic search
        node.client().admin().indices().prepareRefresh().execute().actionGet();
        SearchResponse searchResponse = node.client().prepareSearch()
            .setQuery(QueryBuilders.matchAllQuery())
            .execute().actionGet();

        System.out.println("Total tweets = " + searchResponse.getHits().totalHits());
        for (SearchHit searchHitFields : searchResponse.getHits().getHits()) {
            System.out.println("tweet: " + searchHitFields.getSourceAsString());
        }

        //shutdown elastic search node
        ElasticSearchUtils.stopEmbeddedNode(node);

        //shutdown embedded database
        DatabaseUtil.shutDown(connection);
        }
    }</code></pre>
</div>

        <p>The code is self explanatory, the main part (in bold) is how to configure Easy Batch to read data form the database and index it in ElasticSearch.
        The remaining code is just for starting/stopping the embedded database and ElasticSearch servers.</p>

        <h2>7. Running the tutorial</h2>

        <h3>7.1 From the command line</h3>

        <p>To run the tutorial from scratch, proceed as follow:</p>
        <div class="bs-callout bs-callout-code">
<pre><code>$>git clone https://github.com/EasyBatch/easybatch-framework.git
$>cd easy-batch
$>mvn install
$>cd easybatch-tutorials
$>mvn exec:java -PrunElasticSearchTutorial
</code></pre>
        </div>

        <p>You should see the following output:</p>
        <div class="bs-callout bs-callout-code">
<pre><code>INFO: Initializing easy batch engine
INFO: Data source: Connection URL: jdbc:hsqldb:mem | Query string: select * from tweet
INFO: Strict mode: false
INFO: Total records = 2
INFO: easy batch engine is running...
Total tweets = 2
tweet: {"id":1,"user":"foo","message":"easy batch rocks! #EasyBatch"}
tweet: {"id":2,"user":"bar","message":"@foo I do confirm :-)"}
INFO: Shutting down easy batch engine</code></pre>
        </div>

<h3>7.2 From your IDE</h3>

<p>First, you need to checkout the source code of the tutorial available <a href="https://github.com/EasyBatch/easybatch-framework/tree/master/easybatch-tutorials/src/main/java/org/easybatch/tutorials/intermediate/elasticsearch" target="_blank">here</a>:</p>

<div class="bs-callout bs-callout-code">
    <pre><code>$>git clone https://github.com/EasyBatch/easybatch-framework.git</code></pre>
</div>

<p>If you do not have git installed, you can download a zip file containing the project's source code from GitHub
    <a href="https://github.com/EasyBatch/easybatch-framework/archive/easybatch-3.0.0.zip">here</a>.</p>

<p>Then, import the <code><em>easybatch-tutorials</em></code> module in you favorite IDE and resolve maven dependencies.</p>

<p>Finally, run the <code><em>org.easybatch.tutorials.intermediate.elasticsearch.ElasticSearchTutorial</em></code> class without any argument.</p>

<h2>8. Summary</h2>

<p>In this tutorial, you have learned how to build a typical ETL application with a minimum effort thanks to Easy Batch.</p>

<h2>9. What's next?</h2>

<p>Until now, you have only processed data in standard formats: CSV, XML, JSON and relational.
    What if your data is organized in a specific format? In the next tutorial, you will learn how to implement your own Easy Batch components
    to meet your requirements.</p>

<nav>
    <ul class="pager">
        <li class="previous"><a href="./loading-data.html"><span aria-hidden="true">&larr;</span> Loading data in a database</a></li>
        <li class="next"><a href="custom-data-format.html">Processing custom data format <span aria-hidden="true">&rarr;</span></a></li>
    </ul>
</nav>

            </div>

            <div class="col-md-3 sidebar-right">
                <!-- <div class="inner" data-spy="affix" data-offset-top="40" data-offset-bottom="300"> -->
<div class="inner">
<ul class="list-lg">
    <li class="sidebar-separator">About Easy Batch</li>
    <li >
        <a href="../index.html">Overview</a>
    </li>
    <li >
        <a href="../release-notes.html">Release notes</a>
    </li>
    <li class="sidebar-separator">Documentation</li>
    <li >
        <a href="../documentation/getting-started.html">Getting started</a>
    </li>
    <li >
        <a href="../documentation/architecture.html">Architecture</a>
    </li>
    <li >
        <a href="../documentation/user-guide.html">User guide</a>
    </li>
    <li  class="active" >
        <a href="../tutorials/index.html">Tutorials</a>
    </li>
    <li>
        <a href="../api/index.html" target="_blank">API docs</a>
    </li>
    <li >
        <a href="../documentation/faq.html">FAQs</a>
    </li>
    <li>
        <a href="https://speakerdeck.com/benas/easy-batch" target="_blank">Presentation slides</a>
    </li>
    <li class="sidebar-separator">Get involved</li>
    <li>
        <a href="https://github.com/EasyBatch/easybatch-framework" target="_blank">Source repository</a>
    </li>
    <li>
        <a href="https://github.com/EasyBatch/easybatch-framework/issues" target="_blank">Issue tracker</a>
    </li>
</ul>
</div>
            </div>
        </div>


    </div>
</div>
<!-- FOOTER -->
<footer id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-3 col">
                <div class="block contact-block">
                    <h3>Documentation</h3>
                    <ul class="fa-ul">
                        <li><a href="../documentation/getting-started.html"><i class="fa fa-li fa-play"></i> Getting started</a></li>
                        <li><a href="../documentation/architecture.html"><i class="fa fa-li fa-flask"></i> Architecture</a></li>
                        <li><a href="../documentation/user-guide.html"><i class="fa fa-li fa-book"></i> User guide</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3 col">
                <div class="block contact-block">
                    <h3>Tutorials</h3>
                    <ul class="fa-ul">
                    <li><a href="../tutorials/index.html#basic"><i class="fa fa-li fa-star-o"></i> Basic tutorials</a></li>
                        <li><a href="../tutorials/index.html#intermediate"><i class="fa fa-li fa-star-half-o"></i> Intermediate tutorials</a></li>
                        <li><a href="../tutorials/index.html#advanced"><i class="fa fa-li fa-star"></i> Advanced Tutorials</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3 col">
                <div class="block contact-block">
                    <h3>Get involved</h3>
                    <ul class="fa-ul">
                        <li><a href="https://github.com/EasyBatch/easybatch-framework" target="_blank"><i class="fa fa-li fa-github"></i> Source repository</a></a></li>
                        <li><a href="https://github.com/EasyBatch/easybatch-framework/issues" target="_blank"><i class="fa fa-li fa-bug"></i> Issue tracker</a></li>
                        <li><a href="../documentation/faq.html"><i class="fa fa-li fa-question"></i> FAQs</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3 col">
                <div class="block contact-block">
                    <h3>Become a friend</h3>
                    <ul class="fa-ul">
                        <li><a href="https://twitter.com/intent/tweet?url=http://www.easybatch.org/&text=Easy%20Batch:%20batch%20processing%20with%20Java%20made%20easy&via=md_benhassine" target="_blank"><i class="fa fa-li fa-twitter"></i> Share it on Twitter</a></a></li>
                        <li><a href="https://plus.google.com/share?url=http://www.easybatch.org&text=Easy%20Batch:%20batch%20processing%20with%20Java%20made%20easy" target="_blank"><i class="fa fa-li fa-google-plus"></i> Share it on Google+</a></a></li>
                        <li><a href="https://github.com/EasyBatch/easybatch-framework" target="_blank"><i class="fa fa-li fa-heart"></i> Star it on GitHub</a></li>
                    </ul>
                </div>
            </div>

        </div>

        <br>
        <p class="back-top floatright" style="display: none;">
            <a href="#top"><span></span></a>
        </p>

        <div class="row">
            <div id="toplink"><a href="#top" class="top-link" title="Back to top">Back To Top <i class="fa fa-chevron-up"></i></a></div>

            <div class="subfooter">
                <br>
                <div class="col-md-4">
                    <p>&copy; Easy Batch is created by <a href="http://www.mahmoud-benhassine.fr" target="_blank">Mahmoud Ben Hassine</a> <br>
                    and the <a href="https://github.com/EasyBatch/easybatch-framework#awesome-contributors" target="_blank">awesome contributors</a></p>
                </div>
                <div class="col-md-4 text-center">
                    <iframe src="http://ghbtns.com/github-btn.html?user=EasyBatch&repo=easybatch-framework&type=watch&count=true"
                            allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
                    <iframe src="http://ghbtns.com/github-btn.html?user=EasyBatch&repo=easybatch-framework&type=fork&count=true"
                            allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
                </div>
                <div class="col-md-4">
                    <p class="footer-menu">Easy Batch is open source and is released <br> under the terms of the <a href="http://opensource.org/licenses/mit-license.php/" target="_blank">MIT license</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>

<!--Scripts -->
<script src="../js/jquery.min.js"></script>
<script src="../js/jquery-migrate-1.2.1.min.js"></script> <!--Legacy jQuery support for quicksand plugin-->

<!-- Bootstrap JS -->
<script src="../js/bootstrap.min.js"></script>

<!--JS plugins-->
<script src="../js/plugins/clingify/jquery.clingify.min.js"></script>
<script src="../js/plugins/jRespond/jRespond.js"></script>

<!--Custom scripts mainly used to trigger libraries -->
<script src="../js/script.min.js"></script>
<script src="../js/scrolltotop.js"></script>
<script src="../js/homeScroll.js"></script>
<script src="../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>